<?php if(!defined('PATH_INC')) exit('Request Error!');

require_once 'Captcha.php';

class Bkcaptcha extends Captcha
{
    var $ImageWidth = 85;
    var $ImageHeight = 32;
    var $WordWidth = 18;
    var $WordHeight = 30;
    var $WordSpacing = 0;//间隙

    public function __construct($imagestr = '', $imageres = '', $imagepath = '')
    {
        parent::__construct($imagestr, $imageres, $imagepath);
        $this->Chars = [
            '0' => ['00000011111111110000000000011111111111111000000001111111111111111000000111111111111111111000011111100000000011111001111000000000000001111011110000000000000001110111000000000000000011101110000000000000000111011100000000000000011110111100000000000001111100111110000000000111110000111111111111111111000000111111111111111100000000111111111111110000000000001111111100000000', '00000001111111100000000000011111111111111000000001111111111111111000000111111111111111111000011111100000000011111001111111000000000001111011101100000000000001110111000000000000000011101110000000000000000111011100000000000000001110111100000000000000111100111110000000000111110000111111111111111111000000111111111111111100000001111111111111110000000001101111111100000000', '0000000001110000000000000000000111111111111100000000000111111111111111110000000011111111111111111111000001111111111111111111111000011111110111111111111110001111111000100000011111100011110000000000000001111100111100000000000000011111101111000000000000000111110001111100000000000011111100011111100000000001111110000111111100000111111111100000111111111111111111110000000111111111111111111000000000111111111111111110000000001111111111111111000000'],
            '1' => ['000000000000000000000110000011000000000000000111000011110000000000000011100011111110000000000001110011111111100000011111111001111111111111111111111110011111111111111111111111011111111111111111111111100111111111111111111111100001111110000000111111110000000000000000000000111000000000000000000000011100000000000000000000001110000000000000000000000111000000000000000000000001000', '001000000000000000010001100000000000000011101110000000000000001110111000000000000001111011111111111111111111101111111111111111111110111111111111111111111011111111111111111111100000010000000000011110000000000000000000111000000000000000000011100000000000000000000100', '001100000000000000011100011110000000000000011100111111000000000000111110111111111101111000111100111111111111111111111100111111111111111111111100111111111111111111111100011111111111111111111100000000000000011100111100000000000000000000111100000000000000000000011100'],
            '2' => ['0000000000000000000110000000000000000000000001100000000000000000000000110000001100000000000001111100001110000000000011111111001111000000000011111111100111100000000011111111100111110000000001111111110011111000000000111110111101111100000000111100011110111110000000111100011111001111100000111110001111100111111000111110000111100011111111111110000011110001111111111110000000111100111111111110000000011110001111111110000000001111000001111100000000000011000000011110000000000000000', '000110000000000001111000011110000000000111111001111000000000011111110111100000000001111111101111000000000011111111011110000000001111101110111000000000111100111101110000000011110001111011110000000111100011110111110000111110000111101111110011111000000111011111111111100000001110011111111111000000011100011111111100000000111000011111010000000001110000011100000000000011100000010000000000000110000000000000000000000110', '0000000000000000000000001110000000000000110000000000001111110000000000011100000000000111111100000000000111100000000011111111100000000011101100000000111101110000000000111100000000011110111100000000001110000000001110000111000000000011100000000011100001110000000000111000000001110000011100000000001111000000111000000111000000000011111000111100000001110000000000011111111111000000011100000000000111111111100000000111000000000000111111110000000001110000'],
            '3' => ['000100000000000000001000000001100000000000000001100000011100000001000000001110000011110000011100000001111000011111000011100000001110100011110000011100000001111110011110001111110000011110000011110001111110000011110000011110001111110000011110000001111111111111000111110000001111111111111111111100000000111111101111111111100000000011111000011111111000000000000010000011111110000000000000000000000111000000000', '0010000000000000000100001100000000000000001100111000000010000000011101110000001110000000111011100000111100000001110111100001111000000011101110000011111000001111011111000111110000011110111101011111110000111101111111111111100011111001111111110111111111100001111111001111111111000001111000001111111100000000000000000111110000', '001000000000000000010000110000000000000000110011100000001100000001110111000000111000000011101110000001110000000111011100000011100000001110111000000111100000011101110000011111000000111011110001111110000011110011111111111110001111100111111110011111111110000111111100111111111100000111110000111111110000000010000000011110000000000000000000010000000', '00011000000000000001110000011100000000000001111100011110000001100000011110001111000001110000001111001111100000111000000111110111110000111100000011111011111000011111000001111101111100001111100001111110111111110111110000111111001111111111111111111111001111111111111111111111100111111111111111111111110001111111111111111111111000011111111111111111111000'],
            '4' => ['00000000000011100000000000000000001111100000000000000011111111000000000000001111111110000000000000111110011100000000000011110000111100000000011111000001110000000001111000000011100000000111100000000111000000011111111111111111111100111111111111111111111101111111111111111111111001111111111111111111100001000000000011100000000000000000000111000000000000000000000100000000', '000000000000011110000000000000000000011111100000000000000000011111110000000000000000111111111000000000000000111111111100000000000011111111111110000000000011111111111111000000000011111100001111000000000111111110000111110000000111111111001111111111100011111111111111111111111001111111111111111111111110111111111111111111111111001111111111111111111111000001111111111111111011100000000000110111111000100000000000000001111000000000000000000000011000000000'],
            '5' => ['001111111110000000001000011111111111000000011100011111111111000000011110011110000111000000001110011100000111000000001110011100000111000000001110011100000111100000001110111100000011100000011110111100000011110000111100011100000011111111111100011100000001111111111000011100000000111111110000001000000000111111100000000000000000011100000000000000000000001000011000', '011111111110000000111001111111111110000011111011111111111100000111110111111101110000000111101110000011110000001111011100000111100000011110111000001111100000111101110000011111100011111011100000111111111111110111000001111111111111101110000001111111111111011100000001111111111110111100000011111111110001110000000111100011000001100000000110000000000', '000000011111111100000000010000000000001111111111100000001110000000000011111111111000000011110000000000111111101110000000111100000000001110000011100000000111000000000011100000111100000001110000000000111000001111000000011100000000001110000011111000011111000000000011100000111111111111110000000000111000000111111111111000000000001110000000111111111100000000000011100000000111111110000000', '000000011111111110000000011000000000001111111111100000000111000000000011111111111000000001110000000000111100001110000000011100000000001111000011100000000111000000000011110000111000000001110000000000111100001111000000111100000000001110000011111000001111000000000011100000011111000111100000000000111000000111111111111000000000001111000000111111111100000000000011110000000111111110000000', '000000000000000000000000110000000000001110111001100000011110000000000111111111111100000111110000000001111111111111000001111100000000011111111111110000011111100000000011111110111100000011111000000000111101001111000000111110000000001111111111110000001111100000000011111111111110000011111000000000111110001111110011111110000000001110000011111111111111000000000011100000111111111111110000000001111100000111111111111000000000011111000000111111111110000000000011100000000001111110000000'],
            '6' => ['0000000111111111000000000000111111111111100000000111111111111111100000011111111111111111100001111110001110000111100011110000111000000111101111000001100000000111011100000111000000001110111000001110000000011101110000011100000000111011100000111100000111110111000001111100011111001110000011111111111110001110000011111111111000011000000011111111100000000000000011111100000000000000000000010000000', '0000000111111111000000000000111111111111100000000111111111111111100000011111111111111111100001111110011110000111100011110000111000000111101111000001100000000111011100000111000000001110111000001110000000011101110000011100000000111011100000111100000011110111000001111100001111001110000001111111111110001110000011111111111000011100000011111111100000010000000001111100000000000000000001000000000', '000000000000011111111100000000000000000000011111111111110000000000000000011111111111111111000000000000001111111111111111111000000000000111111100111100011111000000000001111000011100000011110000000000111100000110000000011100000000001111000011110000001111000000000011100000111000000001110000000001111000001110000000111100000000011110000011111000001111000000000011100000111111000111110000000000111100000111111111111000000000001111000001111111111100000000000001110000001111111110000000'],
            '7' => ['001000000000000000000000011100000000000000011110011110000000000011111110011110000000000111111110011110000000001111111110011110000000011111111000011110000011111111000000011100000111111110000000111100001111100000000000111110011111000000000000111111111110000000000000011111111000000000000000011111111000000000000000011111010000000000000000001110000000000000000000', '011000000000000000000000111100000000000000000000111100000000000000011000111000000000000011111100111000000000001111111110111000000000011111111100111000000000111111110000111000000111111100000000111000001111111000000000111100011111000000000000111111111110000000000000111111111000000000000000111111110000000000000000111111000000000000000000111111000000000000000000111110000000000000000000011100000000000000000000', '010000000000000000000001110000000000000000110011100000000000001111110111000000000000111111101110000000000011111111011100000000011111111010111000000011111111001101110000011111110000001011100001111100000000000111101111110000000000001110111110000000000000011111111000000000000000111111000000000000000001111110000000000000000001111000000000000000000'],
            '8' => ['00000000000000111110000000111110000111111110000011111110011111111110001111111110111111111100011111111111110001111101111001111110000001111011100001111100000001110111000001111100000011101110000011111000000111011100000111110000001110111100111111110000111101111111111111110001110001111111100111111111100001111111001111111110000001111000001111111000000000000000000111100000', '00000001100000000000000000000000111110000000000001000000001111100001111100011000011111101001111111100110001111111110111111111101100111111111111111111111110001111111111111100011111000011111111111110000111111001111100111111000011111100011111100011110000011111000111111000111110000011110001111111001111100000111100011111111111111100001111000111111111111111100111110000111111111111111111111000000111111111011111111100000000111111000111111111000000000000100000111111110000000000000000000110101100000', '00000000000000000001111110000000000000000111110000111111110000000000000011111110011111111110000000000001111111111111111111110000000000111111111111110001111100000000001111111111111000001111000000000011110001111110000001110000000000111000001111000000011100000000001110000011111000001111000000000011100001111111000011111000000001111110111111110000111100000000011111111111111110011111000000000001111111100111111111100000000000001111110001111111111000000000000001111000001111111100000000000000000000000001111110000000', '00011000000000011111000000001111110000011111110000000111111100011111111100000111111111011111111110000111111111111111111111100111111111111111111111111011111111111111110011111101111100111111100000111110111110000111110000011111011110000011111100001111101111100011111110000111110111111111111111100011111001111111111111111111111000111111111111111111111100001111111011111111111100000011111100011111111110000000111110000111111111000', '000000000000011000000000000111111111111111111110000111111111111111111111100111111111111111111111110011111111111111111111111101111100001111100001111100011100000011110000011110001110000001111000001111000111000000111000000111100011110000111110000011110001111100111111000001111000111111111111111111111100011111111100111111111100000111111100011111111110000000111110000111111110000'],
            '9' => ['0000011111000000000000000011111111100000001000001111111111100000111000111111111111100001111011111111011111000011110111110000011110000111101111000000111110001111011100000000111000011110111000000001110001111101110000000011100101111011110000000110011111100011110000011101111111000111111011111111111100000111111111111111111000000111111111111111100000000111111111111100000000000011111111100000000', '000000000011000000000000000000011111111000000011100000001111111111000001111100000111111111110000011111000011111111111110000111110000111111111111110000111100001111100001111110001111100111110000001111100011111001111100000011111000111100001111000000111100001111000011110000001111000011110001111000000001100111111000011111000011111111111110000011111111111111111111100000111111111111111111111000000111111111111111111100000000011111111111111111000000000001111111111100000000', '000001111100000000000000000111111110000000010000001111111111000000011000011111111111100000011100011110001111110000011110111100000011110000011100111000000001110000011100111000000001110000011110111000000001110000011100111000000001110000111100111000000001100000111000011100000011100001111000011111000111100111110000001111111111111111110000001111111111111111100000000111111111111110000000000010111111111000000000'],
            'A' => ['000000000000000001111000000000000000000111111100000000000000001111111100000000000001111111000000000000000111111110000000000000011111111100000000000111111111111100000000001111111101111100000000011111111000111100000000111111111000011100000000111111111000011100000000111111111100011100000000111111111111111100000000011111111111111100000000000001111111111110000000000000001111111111110000000000000001111111111000000000000000011111111100000000000000001111111110000000000000000000111110', '000000000000000000110000000000000000000011111000000000000000001111110000000000000011111111000000000000111111111000000000000111111111100000000001111111111100000000001111111111111000000000111111110111110000000111111110000111100000001111111110001111000000011111111000011110000000111111111011111100000000111111111111111000000000011111111111110000000000011111111111110000000000100011111111111000000000000000111111111100000000000000111111111100000000000000011111111000001000000000000011110'],
            'B' => ['00000000110000000000000011111111111111111111001111111111111111111111011111111111111111111110111111111111111111111101110000001110001001111011100000011100000001110111000000111000000011101110000001110000000111011100000111110000001110111100011111100000111101111111111111100011111001111111100111111111100011111110000111111111000011111000000111111100000000000000000111110000', '011111111111111111111100111111111111111111111100111111111111111111111100111111111111111111111100111001100111000010011100111000001111000000011100111000001111000000011100111000000111000000011100111000001111110000011100111100011101111000111110111111111101111000111100011111111001111111111000001111110000111111111000000111100000011111110000', '011111111111111111111001111111111111111111111011111111111111111111110111111111111111111111101110000001110000000111011100000111100000001110111000001111000000011101110000011110000000111011110000111110000001110111101111101100000111101111111111111100001111001111111100111111111100011111110000111111111000011111000000111111100000011110000000111110000', '00000000001110000001111011100000000000111111111111111111111100000000011111111111111111111111100000000111111111111111111111111000000001111111111111111111111100000000001111111111111000011111100000000011110000111100000011110000000000111100001111100001111100000000001111000011111000011111100000000011111000111111000011111000000000111111111111111101111110000000011111111111111111111111000000000111111111110111111111100000000000111111111000111111111000000000000111111100001111111110000000000000000000000000111111000000'],
            'C' => ['0000000001111000000000000000001111111100000000000011111111111111000000001111111111111111000000111111111111111111000011111111101111111111000111111000000001111110011111100000000001111100111100000000000000111101111000000000000001111011110000000000000011110111100000000000000011101110000000000000000111011100000000000000001110111000000000000000111101110000000000000001111011110000000000000011110111100000000000001111000111000000000000011110001110000000000000111000', '000000001101100000000000000000011111111100000000000011111111111111000000001111111111111111100000001111111111111111110000001111110000001111111000011111100000000111111100011111000000000011111100011110000000000011111100111100000000000001111100111100000000000000111100111100000000000000011100111100000000000000111100111100000000000000111100111100000000000000111110111100000000000000111100111000000000000000111100111100000000000000111000011100000000000000111000', '000000011111111000000000000011111111111111000000011111111111111110000001111111111111111110000011111100000011111100001111100000000001111100011110000000000001111000111000000000010001111011110000000000000011110111000000000000000011101111000000000000000111011100000000000000001110111100000000000000011101110000000000000000111011100000000000000001110111000000000000000011101110000000000000001110001110000000000000011100'],
            'D' => ['011111111111111111111000111111111111111111111100111111111111111111111100111111111111111111111110111000000000000000011100111000000000000000011100111000000000000000011100111000000000000000011100111000000000000000011100111000000000000000011100111000000000000000011100111000000000000000111100111100000000000000111100111110000000000001111100011111110000000011111000011111110000001111110000001111111111111111110000000111111111111111100000000011111111111111000000', '011000000000011000000001111111111111111111110011111111111111111111110111111111111111111111101111111111111111111111011110000000000000011110111000000000000000111101110000000000000001111011100000000000000011110111100000000000000111101111000000000000000111011111000000000000001110111100000000000000111101111100000000000001111001111100000000001111110011111000000000111111000111111100000111111100000111111111111111111000000111111111111111100000000111111111111110000000000111111111111000000'],
            'E' => ['111111111111111111111000111111111111111111111100111111111111111111111100111111111111111111111100111110000111000000011100111000000111000000011100111000000111000000011100111000000111000000011100111000000111000000011110111000000111000000011100111000000111000000011100111000000010000000011100111000000000000000011100011000000000000000011100000000000000000000001100', '000000000000000000000010011111111111111111111110111111111111111111111100111111111111111111111100111111111111111111111100111111110111110110111100111000101111101100011100111000000111111000011100111000000111011000011100111000001111110000011100111000001111101000011100111000000111010000011100111000000010000000011100111000000000000000011100010000000000000000011100000000000000000000001000', '001100000110000000000000111111111111111111111100111111111111111111111110111111111111111111111110111111111111111111111100111100001111000110011100111100001111000000011100111000001111100000111110111000001111100000111110111100000111100000111100111100000111010000111100111000000111100000111100111000000111000000011100111000000010000000011100111000000000000000011100010000000000000000011100', '0000000111111111111111111110000000000011111111111111111111110000000000111111111111111111111100000000001111111111111111111111000000000011100000011110000011110000000000111000000111000000011100000000001110000001110000000111000000000011100000011100000001110000000000111000000111000000011100000000001110000001110000000111000000000011100000011100000001110000000000111000000010000000011100000000001111000000000000000111000000000001100000000000000001110000', '000000011000000000000000000000000000001111111111111111111111100000000011111111111111111111111100000000111111111111111111111110000000001111111111111111111111100000000011111111111110001101110000000000111000000111000000011100000000001110000001110000000111100000000011100000111110000001111000000000111000001111100000011110000000001110000011111000000111000000000011100000111110000001110000000000111000000111000000011100000000001110000000110000001111000000000001000000000000000011110000', '0111111111111111111110011111111111111111111110111111111111111111111101111111111111111111111011110000111110000011110111000001111000000011101110000001110000000111011100000011100000001110111000000111000000011101110000001110000000111011100000011110000001110111000000111000000011101110000000100000000111001000000000000000001110'],
            'F' => ['001100000001110000000000001111111111111111111111001111111111111111111111110111111111111111111111111011111111111111111111111000111100000011110000000000011100000001110000000000001110000000111100000000000111100000011110000000000011110000001111000000000001111000000111100000000000111100000011110000000000011110000000110000000000001111000000000000000000000011000000000000000000000', '01111111111111111111100111111111111111111111101111111111111111111111011111111111111111111100111100000011110000000001110000000111000000000011100000001110000000000111000000011100000000001110000000111000000000011100000001110000000000111000000011100000000001110000000010000000000011100000000000000000000', '0000000000000000110000000000000000000001111100011111111111000000000000111110111111110111111000000000001111011110111110111101000000000011111111111111111010000000000000111000000001110000000000000000001110000000110000000000000000000011100000001110000000000000000000111000000011100000000000000000001110000000111000000000000000000011100000001110000000000000000000111000000001000000000000000000001110000000000000000000000000000011100000000000000000000000', '001111000000000000000000000111111111111111111111100011111111111111111111111100111111111111111111111111101111111111111111111111110001111100011111111101100000011110000001110000000000000111100000011100000000000001111000000111100000000000011110000001111000000000000111100000111110000000000001111000001111100000000000011110000001111000000000000111000000011000000000000000110000000000000000000000'],
            'G' => ['000000011111111000000000000001111111111110000010000111111111111111100000001111111111111111110000011111110001101111110000011111000000011011111000011110000000001111111000011100000000000101111000111100000000000000111100111010000000000000011100111000000000000000011100111000000000000000011100111000000000000000011100111000000000000000011100111000000000000000011100111000000000011111111100111100000000111111111100011110000000111111111000', '00000000111111111110000000110000011111111111111000001100001111111111111111000011000111111111111111111000000011111111111111111111000000111111001000011111110000011111100010000001111100000111110000000000001111100001111100000000000001111000011110000000000000011110000111100000000000000011100001111000000000000001111000011110000000000000011110000111100000000000000011100001111000000000000001111000011110000000001111111110000111100000000111111111100001111000000001111111111000001100000000001111111100', '000000011111111100000000000011111111111111000000000111111111111111100000001111111111111111110000001111110000011111111000011111110000000011111000011111100000000001111000011100000000000000111100111100000000000000111100111100000000000000111100111110000000000000111100111100000000000000011100111000000000000000011100111100000000000000011100111100000000000000011100111110000000111111111100111011000000111111111110011101000000111111111100001000000000011111111000', '000000011111111100000000000011111111111100000000011111111111111110000001111111111111111110000011111100000111111110001111100000000001111100011110000000000001111000111000000000000001111011110000000000000011110111000000000000000011101110000000000000000111011100000000000000001110111000000000000000011101110000000000000000111011100000000000000001110111000000000011111111101110000000001111111111001110000000011111111110', '00000000000001111111100000000000000000000001111111111110000000000000000001111111111111111000000000000000111111111111111111000000000000001111110000001111110000000000000111110000000000111110000000000001111000000000001111100000000000011100000000000001111100000000001111000000000000011111000000000011100000000000000011110000000000111000000000000000111100000000001110000000000000001111000000000011100000000000000011110000000000111000000000000000111100000000001110000000000000011111000000000011100000000001111111110000', '00000000000011111111110000000000000000000011111111111111000000000000000001111111111111111100000000000000111111111111111111000000000000001111110000011111110000000000000111111000000000111110000000000011111000000000000111110000000000111100000000000000111100000000001111000000000000001111100000000011100000000000000001110000000000111000000000000000011100000000001110000000000000000111000000000011100000000000000001110000000000111000000000000000011100000000011110000000000000001111000000000011110000000001111111111000', '00000000000001111111100000000000000000000001111111111110000000000000000001111111111111111100000000000000111111111111111111100000000000011111110000011111111000000000000111111100000000111110000000000001111001000000000111100000000000111100011000000001111000000000001111000110000000001111000000000011110001100000000011110000000000111000000000000000011100000000001110000000000000000111000000000011100000000000000001110000000000111000000000000000011100000000001110000000000000000111000000000011110000000001111111110000'],
            'H' => ['00000011001100000000000000000111111111111111111111100001111111111111111111111111001111111111111111111111111000111111111111111111111110000000000001111100001100000000000000001111000000000000000000000001111100000000000000000000001111100000000000000000000001111110000000000000000000001111100000000000000000000001111110000000000000000000001111110000000000000000000001111000000000000000000000011111110110000000000111111111111111111111000001111111111111111111111100001111111111111111111111100000111111111111111111111100', '011111111111111111111100111111111111111111111110111111111111111111111100011111111111111111111000000100001111100000000000000000001111000000000000000000000111000000000000000000000111000000000000000000000111000000000000000000000111000000000000000000000111000000000000000000000111000111100000000000001111000011000000000000001111000000000000011111111111111111111100111111111111111111111110111111111111111111111100011111111111111111111100', '00000001100011000000000000111111111111111111111100111111111111111111111111011111111111111111111111101111111111111111111111110011111101111100000000000000000100111100000000000000000000011110000000000000000000001111000000000000000000000111100000000000000000000011110000000000000000000001111000000000000000000000111100000000000000000000011111000000000000001100011111111111110011001111111111111111111111101111111111111111111111100111111111111111111111110011111111111111111111110000000000010111000000000000', '0111111111111111111110011111111111111111111110111111111111111111111101111111111111111111110001000100111100010000000000000000111011100000000000000001111111000000000000000111101100000000000000001111000000000000000000011110000000000000000000111100000000000000000000111000000000000000000001110000000000000000000111110000000000011111111111111111111101111111111111111111111011111111111111111111110'],
            'I' => ['011111111000000111110000011111111111111111111111001111111111111111111111110111111111111111111111111011111111111111111111110000111111011111111111100000', '0000000110011000000000000011000000000011111111111111111111110000000001111111111111111111111100000000011111111111111111111111000000000011111111111111111111100000'],
            'J' => ['0000000000000000000000111000000000000000000000011100000000000000000000001110000000000000000000000111000000000000000000000011100000000000000000000011111111111111111111111111110111111111111111111111111011111111111111111111111001111111111111111111110000', '00000000000000000000000110000000000000000000000001110000000000000000000000011100000000000000000000000111000000000000000000000011110000000000000000000001111101111111111111111111111111111111111111111111111111101111111111111111111111110011111111111111111111111000'],
            'K' => ['000000000000000110000000000000001100001111000000111111111111111111111100111111111111111111111110111111111111111111111110111111111111111111111100000000001111110000111110000000001111101000001000000000111111111000000000000000111111111000000000000000111111111110000000000001111111111111000000000011111000011111100000011111010000011111100000111110000000011111110000111110000000001111111000111110000000000011111100111110000000000001111100011100000000000000111110000100000000000000011110', '011111111111111111111100111111111111111111111100111111111111111111111100111111111111111111111000010000001111011000000000000000001111100000000000000000001111110000000000000000011111111000000000000000111001111100000000000001110000111110000000000011100000011111000000000111000000001111100000001110000000001111110000011100000000000111111000111000000000000011111100110000000000000000111110000000000000000000011100'],
            'L' => ['0000000000011100001111000011111111111111111111110011111111111111111111111101111111111111111111111110111111111111111111111111001100100000011000011111000000000000000000000111110000000000000000000011110000000000000000000001111000000000000000000000111100000000000000000000011110000000000000000000001111100000000000000000000111110000000000000000000011110000000000000000000000111000000000000000000000011100', '000000000000000000001100000011111111000000000111100001111111111111111111111100111111111111111111111111001111111111111111111111110011111111111111111111111110111111110110011100111111000000000000000000000111110000000000000000000001111100000000000000000000011111000000000000000000000111110000000000000000000001111100000000000000000000011111000000000000000000000111110000000000000000000001111100000000000000000000011111000000000000000000000111100000000000000000000000111000', '1111111111111111111100011111111111111111111100111111111111111111111001111111111111111111110000000000000000000011110000000000000000000111000000000000000000001110000000000000000000011100000000000000000000111100000000000000000001110000000000000000000011100000000000000000000111000000000000000000001110000000000000000000011100'],
            'M' => ['0000110000000000000000000111110000000000000000011111111111111111111001111111111111111111111011111111111111111111100111111100000000000000001111111111000000000000001111111111110000000000000011111111111110000000000000111111111111100000000000011111111111100000000000001111111111000000000000001110111110000000000000001111111000000000000011111111100000000000011111111110000000000111111110000000000001111111100000000000000111111100000000000011011111111111111111111110', '00000001100000000000000000000000000000111111111111111111111000000000001111111111111111111111000000000011111111111111111111100000000000111111111100000000000000000000001111111111100000000000000000000001111111111111000000000000000000000111111111111111100000000000000000001111111111111100000000000000000000001111111111100000000000000000000000011111111100000000000000000000000011111110000000000000000000000001111111100000000000000000000111111111110000000000000000000011111111100000000000000000011111111110000000000000', '00000000000000000000001111000000000000011111111111111111111000000000001111111111111111111111000000000011111111111111111111100000000000111111100000000000000000000000001111111111000000000000000000000001111111111110000000000000000000001011111111111110000000000000000000110111111111111100000000000000000110001111111111100000000000000000000000011111111000000000000000000000000000111110000000000000000000000001111111000000000000000000000111111111100000000000000000000011111111000000000000000000000111111110000000000000'],
            'N' => ['011000000000000000000001111111111111111111110011111111111111111111110111111111111111111111000111111011001001110000001111111100000000000000001111111100000000000000000011111100000000000000000011111100000000000000000011111110000000000000000011111110000000000000000001111110000000000000000001111110000000000000000001111110000000000000000001111111000000000000000001111111000111111111111111111111011111111111111111111110', '000000000111100011111100011111111111111111111110111111111111111111111110111111111111111111111110011111111111111111000000000111111110010000000000000011111111000000000000000001111111000000000000000000011111110000000000000000001111111000000000000000000111111100000000000000000011111111000000000000000001111111100000000000000000011111111000000000000000011111111100000000000111111111111110011111111111111111111110111111111111111111111110011111111111111111111110001111110111110000000000'],
            'O' => ['00000000011110000000000000000001111100000000000000000111111110000000000001111111111111100000000111111111111111100000011111111111111111000000111111000111111111000011111111111111111111001111111001111101111111011111000000100000011110111000000000000000111101111000000000000001111011110000000000000011110111100000000000000111101111000000000000001111011110000000000000011110111100000000000001111100111111000000000011110001111111000000011111100001111111000011111111000001111111111111111110000001111111111111111000000001', '00000000000001111111100000000000000000000001111111111110000000000000000000111111111111110000000000000000011111111111111110000000000000001111110000001111110000000000000111110000000000111110000000000001111000000000000111100000000000111100000000000000111100000000001110000000000000000111000000000011100000000000000001110000000000111000000000000000011100000000001110000000000000000111000000000011100000000000000011110000000000111000000000000000111100000000001111000000000000001111000000000001111000000000000111100000'],
            'P' => ['0111111111111111111111011111111111111111111110111111111111111111111101111111111111111111110011100000001110000000000111000000011100000000001110000000111000000000011100000001110000000000111000000111100000000001111000001111000000000011110000111100000000000111111111111000000000000111111111100000000000000111111110000000000000', '001100000000000000000000001111111111111111111111000111111111111111111111110011111111111111111111111001111111111111111111111001111100000111111110000000111100000001111000000000001111000000111100000000001111110000111110000000000111110000011111000000000001111100001111000000000000111111001111100000000000011111111111100000000000001111111111110000000000000011111111111000000000000', '001100000000000000111000011111111111111111111110011111111111111111111110011111111111111111111110011111111111111111111110111111000011111000000100111110000001110000000000111110000001111000000000011110000001111000000000011110000011110000000000011110000111110000000000011111011111100000000000011111111111100000000000011111111111000000000000011111111111000000000000'],
            'Q' => ['00000000001100000000000000000000011111111000000000000000011111111111100000000000011111111111111100000000001111111111111111100000000111111100000011111100000001111100000000001111110000011110000000000001111000001111000000000000011111000011100000000000000011110000111000000000000000011100001110000000000000000111000011100000000000000001110000111000000000000000011100001110000000000000000111100011110000000000000011111000011111000000000001111111000111111000000000111111110001111111000000111111111110001111111111111111'],
            'R' => ['000000000000000000110000000000000000000011110001111111111111111111110111111111111111111111101111111111111111111111011111111111111111111100111100000111110000110001111000000111100000000011111000011111000000000111111000111111000000001111110000111110000000011111011011111110000000111111111111111111110001111111111111111111110011111111111101111111110011111111100000111111100111111100000000011111000101111000000000011110', '001111111111111111111110011111111111111111111110011111111111111111111110011111111111111111111100011100000001110000000000011110000001110000000000011100000001111000000000011100000001110100000000011100000001111100000000011110000011111110000000011110000111111111111000011111111111111111111100001111111111000111111110000111111110000011111110000011111000000000111110000000000000000000011110', '00000000000001100000000000000000000000110000000000000000000000010000000000000000000000011000000000000111111111111111111111100111111111111111111111111011111111111111111111111101111111111111111111111100011110000001111110000000001110000000111110000000000111100000111100000000000011110000011111000000000001111000001111111000000000111110110111111110000000011111111111111111110000001111111111111111111110000111111111110001111111100011111111110000011111110000111111110000000111111000000110000000000001111100000000000000'],
            'S' => ['00111111100000000000110000111111111000000000111100011111111110000000011111001111111111100000001111100111111111111000000111110111111111111110000011111011111100011111000001111101111110001111110000111110111110100111111000111111011111111011111110011111101111101110111111001111110111111000111111111111111011111100000111111111111000111110000001111111111000001110000000111111111000000000000000000011110000000000000000000000100000000', '0001111100000000000100000111111100000000001100011111111100000000011101111111111100000000111011110001111100000001110111000001111000000011101110000011111000000111011100000011110000001110111000000111110000111101111000000111110001111001110000001111111111100001000000001111111111000000000000001111111100000000000000001111100000', '00000001111111100000000001000000000000111111111100000000011000000000001111111111000000000111000000000011111111111000000001110000000000111101011111000000011100000000001110110011111000000111000000000011111010111111000011110000000000111000011111110000111100000000001111000011111100001111000000000011110000001111100011110000000000111100000011111111111000000000001111000000011111111110000000000001100000000011111111000000'],
            'T' => ['111000000000000000000001110000000000000000000011110000000000000000000111000000000000000000001110000000000000000000011100000000000000000000111000000000000000000001111111111111111111110011111111111111111111110111111111111111111111101111111111111111111110011110000000000000000000111000000000000000000001110000000000000000000011100000000000000000000111000000000000000000001110000000000000000000011100000000000000000000', '11100000000000000000000111000000000000000000001110000000000000000000011100000000000000000000111000000000000000000001111000000000000000000011110000000110000000000111111111111111111111001111111111111111111111011111111111111111111110111111111111111111111101111000000000000001100011110000000000000000000111100000000000000000001110000000000000000000011100000000000000000000111000000000000000000001110000000000000000000001100000000000000000000'],
            'U' => ['0111111111111111100000011111111111111111110000111111111111111111110000111111111111111111110000000000000000001111100000000000000000001111100000000000000000000111000000000000000000001110000000000000000000011100000000000000000000111000000000000000000001110000000000000000000011100000000000000000001110000000000000000000111100011111111111111111110001111111111111111111000001111111111111111100000', '00000000000011001110000000001111111111111111111000000011111111111111111111100000011111111111111111111100000001111111111111111111110000000000000000000001111111100000000000000000000011111100000000000000000000011111100000000000000000000001111110000000000000000000001111011000000000000000000000111000000000000000000000001111100000000000000000000001111100000000000000000000001111000000000000000000001111111000001111111111111111111110000011111111111111111111100000011111111111111111111000000001111110011100001111000000'],
            'V' => ['11111000000000000000000001111110000000000000000000111111111100000000000000011111111111000000000000001111111111111110000000000011111111111111100000000000111111111111111100000000000011111111111111110000000000000111111111111100000000000011111111111111000000000001101011111111110000000000000000111111111000000000000000111111111000000000000001111111111000000000001111111111111000000000001111111111101000000111111111111100000000000111111111111110000000000011111111111110000000000001111111100000000000000000111111000000', '01110000000000000000000111111000000000000000001111111100000000000000001111111111000000000000000111111111100000000000000011111111110000000000000000111111111110000000000000011111111110000000000000001111111110000000000000000011111110000000000000000011111100000000000000011111110000000000000011111111000000000000111111110100000000011111111110011000000001111111100001110000011111111000000000000001111111000000000000000011110010000000000000000', '00000001110000000000000000000000000000111111000000000000000000000000001111111100000000000000000000000001111111111000000000000000000000000111111111100000000000000000000000011111111110000000000000000000000000111111111100000000000000000000000011111111110000000000000000000000001111111111000000000000000000000000011111111000000000000000000000000011111100000000000000000000000011111111000000000000000000000011111111000000000000000000000111111110000000000000000000001111111110000000000000000000001111111100000000000000'],
            'W' => [],
            'X' => ['00000000000000000000011000011100000000000000111110011111000000000000111110001111110000000000111110000111111100000000111110000011111111110000111110000000111111111111111100000000000011111111111000000000000000011111111100000000000000000011111110000000000000000011111111110000000000000111110111111110000000000111100001111111100000011111110000001111111100011111110000000001111111001111100000000000011111100111100000000000000011100', '000000000000000000011100111100000000000000111110111110000000000000111110111111000000000111111100011111110000001111111000001111111100011111100000000111111110111111000000000001111111111110000000000000111111111100000000000000011111111000000000000001111111111111000000000011111111111111110000000111111100011111111000001111110000001111111100011111000000000111111100111100000000000001111110111000000000000000111110000000000000000000001100'],
            'Y' => ['0111000000000000000000011111010000000000000000111111110000000000000001111111100000000000000001111111110000000000000000111111111100000000000000001111111111111110000000001111111111111110000000001111111111111100000000011111111111110000000111111000000000000000011111100000000000000000111100000000000000000111111000000000000000011111000000000000000001111000000000000000000011000000000000000000000', '0110000000000000000000000111111000000000000000000011111110000000000000000001111111100000000000000000111111111000000000000000001111111111100000000000000000111111111100011110000000001111111111111111111000000011111111111111111100000000001111111111111100000000000111111111111100000000011111100000110000000000011111110000000000000000111111110000000000000000111111110000000000000000011111110000000000000000111111000000000000000000011111000000000000000000000111000000000000000000000', '00000000000000000000001110111000000000000000000001001111110000000000000000000011111110000000000000000000111111111100000000000000001111111111100000000000000001111111111110000000000000001111111111110000000000000000001111111111111111110000000001111111111111111110000000000111111111111111100000000001111111111111110000000111111111111111111100000011111111000000000000000001111110000000000000000000111111100000000000000000011111111100000000000000001111110001100000000000000011111000011000000000000000'],
            'Z' => ['000000000000000000111000100000000000000011111011100000000000011111110111000000000011111111101110000000001111111111011100000000111111111110111000000111111100011101110000011111100000111011100011111110000001110111001111111000000011101111111111000000000111011111111000000000001110111111100000000000011101111100000000000000111001110000000000000000100', '0000000000000000000000001110000000000001000000000000000111110000000000111000000000000111111100000000001110000000000011111111000000000011110000000011111111110000000000111100000001111111011100000000001111000001111111000111000000000011100000111111000001110000000000111000111111100000011100000000001110011111100000000111000000000011111111110000000001110000000000111111110000000000011100000000001111111000000000000111000000000011111100000000000001110000'],
        ];
    }

    //二值化，转为数组
    public function getDataArr()
    {
        $res = imagecreatefromstring($this->ImageStr);
        $canvas = imagecreatetruecolor($this->ImageWidth, $this->ImageHeight);
        imagecopy($canvas, $res, 0, 0, 20, 2, $this->ImageWidth, $this->ImageHeight);
        $white = imagecolorallocate($canvas, 255, 255, 255);
        imagefill($canvas, 0, 0, $white);
        imagetruecolortopalette($canvas, false, 256);

        $data = [];
        for($i=0; $i < $this->ImageWidth; $i++)
        {
            for($j=0; $j < $this->ImageHeight; $j++)
            {
                $rgb = imagecolorat($canvas,$i,$j);
                $rgbarray = imagecolorsforindex($canvas, $rgb);

                if($rgbarray['red'] >= 223 && $rgbarray['green'] >= 223 && $rgbarray['blue'] >= 223)
                {
                    $data[$i][$j] = 0;
                    imagecolorset($canvas, $rgb, 255, 255, 255);
                }
                else
                {
                    $data[$i][$j] = 1;
                    imagecolorset($canvas, $rgb, 0, 0, 0);
                }
            }
        }

        imagejpeg($canvas,'img/img1/test'.mt_rand(0,999).'.jpg');


        //降噪
        for($i = 0; $i < $this->ImageWidth; $i++)
        {
            for($j = 0; $j < $this->ImageHeight; $j++)
            {
                $num = 0;
                if($data[$i][$j] == 1)
                {
                    // 上
                    if(isset($data[$i-1][$j]))
                    {
                        $num = $num + $data[$i-1][$j];
                    }
                    // 下
                    if(isset($data[$i+1][$j]))
                    {
                        $num = $num + $data[$i+1][$j];
                    }
                    // 左
                    if(isset($data[$i][$j-1]))
                    {
                        $num = $num + $data[$i][$j-1];
                    }
                    // 右
                    if(isset($data[$i][$j+1]))
                    {
                        $num = $num + $data[$i][$j+1];
                    }
                    // 上左
                    if(isset($data[$i-1][$j-1]))
                    {
                        $num = $num + $data[$i-1][$j-1];
                    }
                    // 上右
                    if(isset($data[$i-1][$j+1]))
                    {
                        $num = $num + $data[$i-1][$j+1];
                    }
                    // 下左
                    if(isset($data[$i+1][$j-1]))
                    {
                        $num = $num + $data[$i+1][$j-1];
                    }
                    // 下右
                    if(isset($data[$i+1][$j+1]))
                    {
                        $num = $num + $data[$i+1][$j+1];
                    }
                }

                if($num <= 3)
                {
                    $data[$i][$j] = 0;
                }
            }
        }


        $this->DataArr = $data;
    }

    function GetNumStr()
    {
        $result = '';
        $data = [];
        $dataarr = [];
        $flag = 0;//切割是否开始
        $num = 0;

        //横切割
        foreach($this->DataArr as $i => $val)
        {
            $sum = array_sum($val);
            if($sum > 0)
            {
                if($flag == 0)
                {
                    $flag = 1;
                }
                for($j = 0; $j < $this->ImageHeight; $j++) $dataarr[$num][$i][$j] = $val[$j];
            }
            else
            {
                if($flag == 1)
                {
                    $flag = 0;
                    $num++;
                }
            }
        }
        //exit(var_dump($dataarr));

        $minlen = 4;//最小字符
        $maxlen = 4;//最大字符长度 根据情况调整
        $width3 = 60;
        $width4 = 80;//4个字符的最小宽度

        $dataarr2 = [];
        $dataarrnum = count($dataarr);
        for($num = 0; $num < $dataarrnum; $num++)
        {
            $width = count($dataarr[$num]);
            if($width < 4) continue;
            if($width > $maxlen)//根据情况调整
            {
                if($width >= $width4) $divnum = 4;
                elseif($width >= $width3) $divnum = 3;
                else $divnum = 2;

                $divide = ['0' => 0, $divnum => $width - 1];
                $divide2 = [];
                $i = 1;
                $dataarr[$num] = array_values($dataarr[$num]);
                for($j = 0; $j < $width; $j++)
                {
                    $len = $j - $divide[$i-1];
                    $len2 = $width - $j;
                    if($len > $minlen && $len2 > $minlen)
                    {
                        $sum = array_sum($dataarr[$num][$j]);
                        if($sum <= 1) $divide[$i++] = $j;
                        elseif($sum <= 3) $divide2[] = $j;//次高点
                    }
                    if($i == $divnum) break;
                }
                /*var_dump($divide);
                var_dump($divnum);
                var_dump($divide2);
                var_dump($this->WordSpacing);
                exit();*/
                //不够数，找低点
                if($i < $divnum)
                {
                    sort($divide);
                    for($k = 0; $k < $i+1; $k++)//$divide共$i+1个
                    {
                        //可以切割了
                        if($divide[$k+1] - $divide[$k] > $maxlen)
                        {
                            $lastpos = $divide[$k];
                            foreach($divide2 as $val)
                            {
                                $n = round(($divide[$k+1] - $lastpos)/($this->WordWidth + $this->WordSpacing));//可分割字符数
                                if($val-$lastpos > $minlen && $divide[$k+1]-$val > $minlen && abs(($lastpos + ($divide[$k+1] - $lastpos) / $n) - $val) < 3)
                                {
                                    //exit(var_dump($val));
                                    $divide[] = $val;
                                    $lastpos = $val;
                                }
                            }
                        }
                    }
                }
                //exit(var_dump($divide));
                sort($divide);
                //exit(var_dump($divnum));
                //处理两头的空白
                for($i = 0; $i < $divnum; $i++)
                {
                    $arr = array_slice($dataarr[$num], $divide[$i], $divide[$i+1] - $divide[$i]);
                    for($k = 0; $k <= 5; $k++)
                    {
                        $sum = array_sum($arr[$k]);
                        if($sum == 1) unset($arr[$k]);
                        else break;
                    }
                    $arrlen = count($arr);
                    for($k = $arrlen - 1;$k >= $arrlen - 5; $k--)
                    {
                        $sum = array_sum($arr[$k]);
                        if($sum == 1) unset($arr[$k]);
                        else break;
                    }
                    $dataarr2[] = $arr;
                }
            }
            else
            {
                $dataarr2[] = $dataarr[$num];
            }
        }
        $dataarr = $dataarr2;

        //竖切割
        $halfheight = $this->ImageHeight / 2;
        for($num = 0; $num < 4; $num++)
        {
            for($j = 0; $j < $this->ImageHeight; $j++)
            {
                $lastsum = $sum;
                $sum = 0;
                foreach($dataarr[$num] as $key=>$val)
                {
                    $sum += $dataarr[$num][$key][$j];
                }
                if($sum < 3 && empty($lastsum))
                {
                    $delrow = 0;
                    if($j < $halfheight - 3 && $j>0)
                    {
                        $delrow = $j - 1;//上一个
                    }
                    elseif($j < $this->ImageHeight - 1 && $j > $halfheight + 3)
                    {
                        $delrow = $j + 1;//下一个
                    }

                    foreach($dataarr[$num] as $key => $val)
                    {
                        unset($dataarr[$num][$key][$j]);
                    }
                }
            }
        }


        $num2 = 0;
        //exit(var_dump($dataarr));
        $dataarrnum = count($dataarr);
        for($num = 0; $num < $dataarrnum; $num++)
        {
            $width = count($dataarr[$num]);
            if($width < 3)
            {
                unset($dataarr[$num]);
                continue;
            }
            foreach($dataarr[$num] as $key=>$val)
            {
                $data[$num2] .= join('', $dataarr[$num][$key]);
            }
            $num2++;
        }

        $this->PrintChar($dataarr);

        //打印结束
        var_dump($data);

        //进行关键字匹配
        foreach($data as $numStr)
        {
            $max = 0.0;
            $num = 0;
            foreach($this->Chars as $key=>$val)
            {
                foreach($val as $v)
                {
                    $percent=0.0;
                    similar_text($v, $numStr,$percent);
                    if($percent > $max)
                    {
                        $max = $percent;
                        $num = $key;
                        if(intval($percent) > 94) break 2;
                    }
                }
            }
            //echo $max .' '.$num .' ';
            $result .= $num;
        }
        $this->Data = $result;
    }

    function GetResult()
    {
        $this->getDataArr();
        $this->GetNumStr();
        return $this->Data;
    }
}
